name: Actions ðŸ˜Ž

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    name: Build my project âœ¨
    runs-on: self-hosted
    if: github.ref == 'refs/heads/Test-Actions'
    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          lfs: false

      - name: discord-action-embed
        # You may pin to the exact commit or the version.
        # uses: rguillaume/discord-action-embed@eea5e19de504a66ec20b52f1a06b3b27985fa3ec
        uses: rguillaume/discord-action-embed@v1.0.4
        with:
          # Discord webhook URL
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # Message to be sent
          message: "Nouvelle build disponible ðŸŽ® Voici le lien pour tÃ©lÃ©charger l'APK : https://www.dropbox.com/home/Build"
          embed: '{ "color": 3447003, "title": "Nouvelle Build Disponible", "description": "Une nouvelle version de l APK vient de sortir!", "url": "https://www.dropbox.com/home/Build", "author": { "name": "Arthur", "icon_url": ""} }'

      # Build
      - name: Build project
        uses: game-ci/unity-builder@v4.3.0
        env:
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android

      # Output
      - uses: actions/upload-artifact@v4.6.0
        with:
          name: Build
          path: build

      - name: Supprimer l'ancien APK (sans erreur si absent)
        run: |
          curl -X POST https://api.dropboxapi.com/2/files/delete_v2 \
            --header "Authorization: Bearer ${{ secrets.DROPBOX_ACCESS_TOKEN }}" \
            --header "Content-Type: application/json" \
            --data "{\"path\": \"/Build/Android.apk\"}" || echo "Fichier non trouvÃ©, on continue..."

      - name: Dropbox Large File Uploader
        uses: thedefaultman/dropbox-large-file-uploader@v2.3.5
        with:
          app_key: ${{ secrets.DROPBOX_APP_KEY }}
          app_secret: ${{ secrets.DROPBOX_APP_SECRET }}
          # Dropbox API refresh token.
          refresh_token: ${{ secrets.REFRESH_TOKEN_DROPBOX }}
          # Path to the file to upload.
          file_path: 'build/Android/Android.apk'
          # Destination path in Dropbox.
          dropbox_path: '/Build/Android.apk'
          
      #- name: Send link to Discord
       # run: |
        #  curl -F "content=Nouvelle build disponible ðŸŽ® Voici le lien pour tÃ©lÃ©charger l'APK : https://www.dropbox.com/home/Build" ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Installer jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Discord Message Delete
        run: |
          MESSAGES=$(curl -s -X GET "https://discord.com/api/v10/channels/1343977032123682962/messages?limit=10" \
            -H "Authorization: Bot MTM0Mzk2NTM4MDkwMDgxOTA4Nw.GZkzJv.OmYHH5zM-WKI5u_BniO8j-m_WrafzsJ1lXbl60" \
            -H "User-Agent: PostmanRuntime/7.29.0" \
            -H "Content-Type: application/json" | jq -r '.[].id')

          # Supprime chaque message un par un
          for MESSAGE_ID in $MESSAGES
          do
              curl -X DELETE "https://discord.com/api/v10/channels/1343977032123682962/messages/$MESSAGE_ID" \
              -H "Authorization: Bot MTM0Mzk2NTM4MDkwMDgxOTA4Nw.GZkzJv.OmYHH5zM-WKI5u_BniO8j-m_WrafzsJ1lXbl60" \
              -H "User-Agent: PostmanRuntime/7.29.0" \
              -H "Content-Type: application/json"
              echo "Message $MESSAGE_ID supprimÃ©"
              sleep 1  # Petite pause pour Ã©viter les limites de rate (5 messages/sec)
          done
          
      - name: Remove Game
        run: |
          TARGET_DIR="/home/polo/RunnerGPC/_work/grand-projet-commun-depths-of-hue/grand-projet-commun-depths-of-hue/build/Android"
          if [ -e "$TARGET_DIR/Android.apk" ]; then
            lsattr "$TARGET_DIR/Android.apk"
            sudo chattr -i "$TARGET_DIR/Android.apk"
          fi
          chmod -R u+w "$TARGET_DIR"
          rm -rf "$TARGET_DIR"
          sudo rm -r /home/polo/RunnerGPC/_work/_actions/game-ci
          sudo rm -r /home/polo/RunnerGPC/_work/grand-projet-commun-depths-of-hue/grand-projet-commun-depths-of-hue/Library
          sudo rm -r /home/polo/RunnerGPC/_work/grand-projet-commun-depths-of-hue/grand-projet-commun-depths-of-hue/Assets/Editor
          sudo rm -r /home/polo/RunnerGPC/_work/grand-projet-commun-depths-of-hue/grand-projet-commun-depths-of-hue/Logs
          sudo rm -r /home/polo/RunnerGPC/_work/grand-projet-commun-depths-of-hue/grand-projet-commun-depths-of-hue/UserSettings
