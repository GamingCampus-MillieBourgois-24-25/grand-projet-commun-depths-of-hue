name: Actions üòé

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    name: Build my project ‚ú®
    runs-on: self-hosted
    if: github.ref == 'refs/heads/Test-Actions'
    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          lfs: false

      # Build
      - name: Build project
        uses: game-ci/unity-builder@v4.3.0
        env:
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android

      # Output
      - uses: actions/upload-artifact@v4.6.0
        with:
          name: Build
          path: build

      - name: Corriger les permissions
        run: sudo chown -R $USER:$USER build/

      - name: V√©rifier que le fichier APK existe
        run: |
          if [ ! -f "build/Android/Android.apk" ]; then
            echo "Erreur : Le fichier APK n'existe pas !"
            exit 1
          fi
      
      - name: V√©rifier les fichiers g√©n√©r√©s
        run: |
          ls -lah build/
          ls -lah build/Android/

      - name: Upload APK to Google Drive
        uses: Fork-on-the-Table-Collective/upload-to-download-from-gdrive@v2.0.0
        with:
          credentials: ${{ secrets.GOOGLE_CREDENTIALS }}
          actionType: upload
          localPath: 'build/Android/Android.apk'
          emptyUploadFolder: false

      - name: Get Google Drive file link
        id: get-link
        run: |
          # Extraire l'ID du fichier t√©l√©charg√© (output de l'action pr√©c√©dente)
          FILE_ID=$(echo "${{ steps.upload-apk.outputs.fileId }}")
          echo "::set-output name=file_link::https://drive.google.com/file/d/$FILE_ID/view?usp=sharing"
          
      - name: Send link to Discord
        run: |
          curl -F "content=Nouvelle build disponible üéÆ Voici le lien pour t√©l√©charger l'APK : ${{ steps.get-link.outputs.file_link }}" ${{ secrets.DISCORD_WEBHOOK_URL }}
          
      # End Build
      - name: Remove Game
        run: |
          sudo rm -r /home/polo/RunnerGPC/_work/grand-projet-commun-depths-of-hue/
